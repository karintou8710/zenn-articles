---
title: CJS, ESM, トランスパイラの依存解決
type: tech
topics: []
emoji: 🔖
published: false
---
zenn-cli に wysiwyg エディターを追加しようと作業をしていたのですが、そこで CJS である `zenn-markdown-html` をブラウザでも実行可能にしようと、ESM に書き換えていました。

しかし、ブラウザで実行すると期待通りだったのですが、サーバー側のCJSで実行すると import がなぜか `{default: fn}` の形式になり、エラーになりました。

調べてみると、`zenn-markdown-html` の依存先である CJS の [@steelydylan/markdown-it-imsize](https://www.npmjs.com/package/@steelydylan/markdown-it-imsize) が関連していました。

本記事ではこの現象が起きた理由を、CJS, ESM, トランスパイラーの観点から調べていきます。

## CJS と ESM

「CJS と ESM の違い？ あ〜わかるよ。require か import の違いでしょ？？」

ってぐらいの知識しかなかったので、基本から振り返るために JavaScript と TypeScript のモジュールシステムについて調べてみます。

ESModule(ESM) はブラウザで採用されている [ECMAScript の仕様](https://tc39.es/ecma262/multipage/ecmascript-language-scripts-and-modules.html#sec-modules)にあるモジュールシステムです。以下のように `import` `export` を書けます。

CommonJS(CJS) はサーバー (Node)で採用されている仕様で、その中に `require` と `import` によるモジュールシステムがあります。（細かい話だと、ESModuleの比較対象は CJS Module になりそう）

---

ここからは、以下のフォルダ構造を前提に話します。

```:フォルダ構造
- main-esm.mjs
- sub-esm.mjs
- main-cjs.js
- sub-cjs.js
```

### 基本的な文法 

ESM は以下です。

```js:main-esm.js
import hello from "sub-esm.js" // 拡張子の指定が必須
hello();
```

```js:sub-esm.js
export default function hello() {
  console.log("Hello");
}
```

`main-esm.js` をブラウザで読み込むと、現在のパスから `sub-esm.js` を探し、`hello`を読み込んでくれます。特徴的なのは拡張子が必須なことです。いい感じに解決してくれないので、拡張子を描かないとエラーになります。

CJS は以下です。

```js:main-cjs.js
const hello = require('./sub-cjs'); // 拡張子は必要ない
hello()
```

```js:sub-cjs.js
module.exports = () => {
  console.log("Hello");
}
```

`module.exports` が ESM におけるデフォルトエクスポートみたいになっており、`require`で読み込む仕組みです。拡張子はいい感じに解決してくれます。

### ランタイムの制約

ブラウザ用だから ESM は Node では実行できないんでしょ？と思ってましたが、意外にも Node で実行可能です。

実は ESM 対応は、Node v14 で stable になったみたいです。

https://nodejs.medium.com/node-js-version-14-available-now-8170d384567e

逆に、CJS は現在でも主要のブラウザ上で実行する事はできません。

### 相互インポート

上記の話はあくまでどちらかのモジュールで統一されていた場合なので、実際は相互にインポートすることになることがあります。それらを確認していきます。

#### ESM => CJS

これは v14 の時点では既に可能だったみたいです。`module.exports` が、ESM のデフォルトエクスポートとして認識されます。

#### CJS => ESM

こちらは [Node v23](https://nodejs.org/en/blog/release/v23.0.0/) で stable になったみたいです。

https://nodejs.org/api/modules.html#loading-ecmascript-modules-using-require

ドキュメントによると、デフォルトエクスポートは `module.default` という名前付きのエクスポートになるみたいです。

なので、`const { default: hello } = require('./sub-esm.mjs');` のように、一度展開する必要があります。

## TypeScriptが絡むと

ここまではシンプルな話でしたが、TypeScript が絡むと途端にややこしくなります。

### TypeScript における import
